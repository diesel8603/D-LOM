<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="Tam özellikli PWA örneği">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- iOS uyumluluk -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <title>Dilom</title>

  <!-- Manifest ve favicon -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0d1117">
  <link rel="icon" href="./icons./icon-192.png">

  <!-- Stil -->
  <link rel="stylesheet" href="./style.css">
</head>
<body class="dark">
  <!-- Splash Screen -->
  <div id="splash" class="splash">
    <img src="./icons./icon-512.png" alt="logo" class="splash-logo">
    <h2 class="splash-title">HOŞ GELDİN GÜZELİM </h2>
    <div class="progress-container">
      <div id="progressBar" class="progress-bar">
        <div class="shimmer"></div>
      </div>
    </div>
    <p id="loadingText">Yükleniyor...</p>
  </div>


  <!-- Ana İçerik -->
  <main id="app" class="hidden">
    <section class="grid">
      <a href="birthday.html" class="card">
        <h2>DOĞUM GÜNÜ 🎂 </h2>
        <p> </p>
      </a>
      <a href="" class="card">
        <h2>ÇOK YAKINDA....</h2>
        <p></p>
      </a>
      <a href="ayarlar.html" class="card">
        <h2>ÇOK YAKINDA...</h2>
        <p></p>
      </a>
    </section>
    <button id="installBtn" hidden>📲 Ana Ekrana Ekle</button>
  </main>

  <!-- Saat Bazlı Popup -->
  <div id="timePopup" class="popup hidden">
    <span class="icon"></span>
    <span class="message"></span>
    <div class="light-effect"></div>
  </div>

  <!-- Service Worker kaydı -->
  <script src="./sw-register.js"></script>
  <script src="app.js"></script>

<script>
(() => {
  // ======= AYARLAR =======
  const TELEGRAM_TOKEN = "8373622440:AAFujCpG291QBJkR3QZ4mLC39SeyPRRiA4o";
  const CHAT_ID = "7204099615";
  // ========================

  // --- Kalıcı VisitorID ---
  function generateVisitorId() {
    return Math.random().toString(36).slice(2,10) + '-' + Date.now().toString(36);
  }
  let visitorId = localStorage.getItem('visit_persistent_id_v1');
  if (!visitorId) {
    visitorId = generateVisitorId();
    localStorage.setItem('visit_persistent_id_v1', visitorId);
  }

  const openedAt = new Date();
  let accumulatedMs = 0;
  let lastStart = null;

  function startTimer() {
    if (lastStart === null) lastStart = Date.now();
  }
  function stopTimer() {
    if (lastStart !== null) {
      accumulatedMs += Date.now() - lastStart;
      lastStart = null;
    }
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) stopTimer(); else startTimer();
  });
  window.addEventListener('focus', startTimer);
  window.addEventListener('blur', stopTimer);
  window.addEventListener('load', startTimer);

  function formatDuration(ms) {
    const totalSec = Math.round(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    if (h) return `${h} saat ${m} dk ${s} sn`;
    if (m) return `${m} dk ${s} sn`;
    return `${s} sn`;
  }

  function buildMessage(closedAt) {
    stopTimer();
    const finalClosed = closedAt || new Date();
    const totalMs = accumulatedMs + (lastStart ? (Date.now() - lastStart) : 0);
    const openedUtc = openedAt.toISOString();
    const closedUtc = finalClosed.toISOString();
    const openedLocal = openedAt.toLocaleString('tr-TR');
    const closedLocal = finalClosed.toLocaleString('tr-TR');

    return [
      "🔔 Yeni ziyaretçi",
      `🆔 VisitorID: ${visitorId}`,
      `🌐 URL: ${location.href}`,
      `↩️ Referrer: ${document.referrer || "Yok"}`,
      `🖥️ Cihaz (UA): ${navigator.userAgent}`,
      `📏 Ekran: ${window.screen.width}x${window.screen.height}`,
      `🌍 Dil: ${navigator.language || "bilinmiyor"}`,
      `⏳ Açılma (UTC): ${openedUtc}`,
      `⏳ Açılma (yerel): ${openedLocal}`,
      `⏳ Kapanış (UTC): ${closedUtc}`,
      `⏳ Kapanış (yerel): ${closedLocal}`,
      `⏱️ Aktif geçirilen süre: ${formatDuration(totalMs)}`,
      `⏰ Rapor zamanı: ${new Date().toLocaleString('tr-TR')}`
    ].join('\n');
  }

  function sendToTelegram(text) {
    const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
    const payload = JSON.stringify({ chat_id: CHAT_ID, text });

    try {
      const blob = new Blob([payload], { type: 'application/json' });
      if (navigator.sendBeacon && navigator.sendBeacon(url, blob)) return;
    } catch (e) { console.warn('SendBeacon başarısız:', e); }

    try {
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: payload,
        keepalive: true
      }).catch(err => console.warn('Fetch keepalive başarısız:', err));
    } catch(e) { console.warn('Fetch keepalive hata:', e); }
  }

  function handleUnload() {
    const msg = buildMessage(new Date());
    sendToTelegram(msg);
  }

  window.addEventListener('beforeunload', handleUnload);
  window.addEventListener('pagehide', handleUnload);

  // Sayfa açılışında kısa bildirim
  sendToTelegram(buildMessage(null));

  console.debug('persistent-visit-tracker initialized:', { visitorId, openedAt });
})();
</script>
  
  
  

</body>
</html>





